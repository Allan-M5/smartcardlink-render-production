<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartCardLink Admin Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 1rem;
      background: none;
      position: relative;
      color: white;
    }
    #bg-video {
      position: fixed;
      right: 0;
      bottom: 0;
      min-width: 100%;
      min-height: 100%;
      z-index: -100;
      filter: brightness(0.4) saturate(1.2);
      object-fit: cover;
    }
    .form-card {
      background-color: #111;
      border-radius: 1rem;
      padding: 2rem;
      width: 100%;
      max-width: 750px;
      border: 1px solid #333;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      overflow-y: auto;
    }
    h1.title {
      color: #FFD700;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    button, .file-input-label {
      transition: background-color 0.3s, color 0.3s;
      font-weight: 600;
      padding: 0.75rem;
      border-radius: 0.375rem;
      cursor: pointer;
      width: 100%;
      margin-top: 1rem;
      text-align: center;
      border: 1px solid transparent;
    }
    .section-header {
      background-color: #1f2937;
      color: #FFD700;
      padding: 0.5rem;
      text-align: center;
      border-radius: 0.375rem;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    label {
      color: white;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      display: block;
    }
    input, textarea {
      width: 100%;
      padding: 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #ccc;
      resize: vertical;
      box-sizing: border-box;
      background-color: white;
      color: black;
    }
    .grid-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .top-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1rem;
    }
    .top-buttons button {
      flex: 1 1 45%;
      margin-top: 0;
    }
    .action-button {
      background-color: black;
      color: white;
      border: 1px solid #FFD700;
    }
    .action-button:hover {
      background-color: #FFD700;
      color: black;
    }
    .btn-view-pdf {
      background-color: #fff;
      color: black;
      border: 1px solid #FFD700;
    }
    .btn-view-pdf:hover, .btn-view-pdf.pressed {
      background-color: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    .btn-create-vcard {
      background-color: black;
      color: white;
      border: 1px solid #FFD700;
    }
    .btn-create-vcard:hover, .btn-create-vcard.pressed {
      background-color: #22c55e;
      color: white;
      border-color: #22c55e;
    }
    .photo-upload-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .photo-upload-container .url-input-container {
      flex: 1;
    }
    .file-input-label {
      background-color: #ef4444;
      color: white;
      border: none;
      flex: 0 0 120px;
      margin-top: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 600;
    }
    .file-input-label:hover {
      background-color: #3b82f6;
      color: white;
    }
    #photoFile { display: none; }
    .btn-save-info {
      background-color: black;
      color: white;
      border: 1px solid #FFD700;
    }
    .btn-save-info:hover {
      background-color: #FFD700;
      color: black;
    }
    .toast-message {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background-color: #FFD700;
      color: black;
      padding: 1rem 2rem;
      border-radius: 0.5rem;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (min-width: 768px) {
      .photo-upload-container {
        flex-direction: row;
        align-items: flex-end;
      }
    }
  </style>
</head>
<body>
  <video autoplay muted loop playsinline id="bg-video">
    <source src="https://res.cloudinary.com/dicvwaud3/video/upload/v1754439276/oyvgam7oizwizgwxaxge.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  <div class="form-card">
    <h1 class="title">SmartCardLink Admin Form</h1>
    <div class="top-buttons">
      <button id="view-pdf-btn" class="btn-view-pdf">View Client Info PDF</button>
      <button id="create-vcard-btn" class="btn-create-vcard">Create vCard</button>
    </div>
    <form id="adminForm" autocomplete="off">
      <div class="section-header">Personal Details</div>
      <div class="grid-2col">
        <div><label for="fullName">Full Name</label><input type="text" id="fullName" name="fullName" required /></div>
        <div><label for="title">Title/Position</label><input type="text" id="title" name="title" /></div>
      </div>
      <div class="grid-2col">
        <div><label for="phone1">Phone Number 1 (Main/Default)</label><input type="tel" id="phone1" name="phone1" required /></div>
        <div><label for="phone2">Phone Number 2</label><input type="tel" id="phone2" name="phone2" /></div>
      </div>
      <div><label for="phone3">Phone Number 3</label><input type="tel" id="phone3" name="phone3" /></div>
      <div class="grid-2col">
        <div><label for="email1">Email 1 (Main/Default)</label><input type="email" id="email1" name="email1" required /></div>
        <div><label for="email2">Email 2</label><input type="email" id="email2" name="email2" /></div>
      </div>
      <div><label for="email3">Email 3</label><input type="email" id="email3" name="email3" /></div>

      <div class="section-header">Business Details</div>
      <div class="grid-2col">
        <div><label for="companyName">Company Name</label><input type="text" id="companyName" name="companyName" /></div>
        <div><label for="businessWebsite">Business Website</label><input type="url" id="businessWebsite" name="businessWebsite" /></div>
      </div>
      <div class="grid-2col">
        <div><label for="portfolioWebsite">Portfolio Website</label><input type="url" id="portfolioWebsite" name="portfolioWebsite" /></div>
        <div><label for="locationMapUrl">Location Map URL</label><input type="url" id="locationMapUrl" name="locationMapUrl" /></div>
      </div>

      <div class="section-header">Photo Upload</div>
      <div class="photo-upload-container">
        <div class="url-input-container">
          <label for="photoUrl">Photo URL</label>
          <small style="color:#FFD700; display:block; margin-bottom:0.25rem;">(Auto-populated after upload)</small>
          <input type="url" id="photoUrl" name="photoUrl" readonly />
        </div>
        <label for="photoFile" id="photo-upload-label" class="file-input-label">Photo Upload</label>
        <input type="file" id="photoFile" accept="image/*" />
      </div>
      <div id="photo-preview-container" style="margin-top: 1rem; text-align: center; display: none;">
        <img id="photo-preview" src="#" alt="Photo Preview" style="max-width: 150px; height: 150px; object-fit: cover; border-radius: 50%; border: 2px solid #FFD700;"/>
      </div>

      <div class="section-header">Working Hours</div>
      <div class="grid-2col">
        <div><label for="monFriStart">Mon-Fri Start</label><input type="time" id="monFriStart" name="monFriStart" value="08:00" /></div>
        <div><label for="monFriEnd">Mon-Fri End</label><input type="time" id="monFriEnd" name="monFriEnd" value="17:00" /></div>
        <div><label for="satStart">Saturday Start</label><input type="time" id="satStart" name="satStart" value="09:00" /></div>
        <div><label for="satEnd">Saturday End</label><input type="time" id="satEnd" name="satEnd" value="12:00" /></div>
        <div><label for="sunStart">Sunday Start</label><input type="time" id="sunStart" name="sunStart" /></div>
        <div><label for="sunEnd">Sunday End</label><input type="time" id="sunEnd" name="sunEnd" /></div>
      </div>

      <div class="section-header">Social Links</div>
      <div class="grid-2col">
        <div><label for="facebook">Facebook</label><input type="text" id="facebook" name="facebook" /></div>
        <div><label for="instagram">Instagram</label><input type="text" id="instagram" name="instagram" /></div>
        <div><label for="twitter">X (Twitter)</label><input type="text" id="twitter" name="twitter" /></div>
        <div><label for="linkedin">LinkedIn</label><input type="text" id="linkedin" name="linkedin" /></div>
        <div><label for="tiktok">TikTok</label><input type="text" id="tiktok" name="tiktok" /></div>
        <div><label for="youtube">YouTube</label><input type="text" id="youtube" name="youtube" /></div>
      </div>

      <div class="section-header">Bio</div>
      <textarea id="bio" name="bio" rows="4"></textarea>

      <div class="section-header">Address</div>
      <input type="text" id="address" name="address" />

      <button type="submit" id="save-btn" class="btn-save-info">Save Info</button>
    </form>
    <div id="toast-message" class="toast-message"></div>
  </div>

<script>
  // C:\Users\ADMIN\Desktop\smartcardlink-app\admin-form.html (REPLACEMENT SCRIPT)
  
  (function () {
    'use strict';

    // FIX 3: Set global API override and base URL
    const API_BASE = "https://smartcardlink-api.onrender.com"; // Hardcoded for deployment stability
    const API_URL = `${API_BASE}/api`; 

    const params = new URLSearchParams(window.location.search);
    const clientId = params.get('id');

    // ------------------------
    // DOM Elements
    // ------------------------
    const form = document.getElementById('adminForm');
    const viewPdfBtn = document.getElementById('view-pdf-btn');
    const createVcardBtn = document.getElementById('create-vcard-btn');
    const photoUploadInput = document.getElementById('photoFile');
    const photoUrlInput = document.getElementById('photoUrl');
    const photoUploadLabel = document.getElementById('photo-upload-label');
    const photoPreviewContainer = document.getElementById('photo-preview-container');
    const photoPreview = document.getElementById('photo-preview');
    const saveBtn = document.getElementById('save-btn');
    const toastMessage = document.getElementById('toast-message');

    let isSaving = false;

    // ------------------------
    // Helper Constants and Functions (RESTORED FROM adminForm.js)
    // ------------------------

    const SOCIAL_PREFIXES = {
      facebook: 'https://facebook.com/',
      instagram: 'https://instagram.com/',
      twitter: 'https://twitter.com/',
      linkedin: 'https://linkedin.com/in/',
      tiktok: 'https://tiktok.com/@',
      youtube: 'https://youtube.com/',
    };

    /**
     * FIX 1: Normalizes a social media link to the required full URL format.
     */
    const normalizeSocialLink = (platform, input) => {
      if (!input || typeof input !== 'string' || input.trim() === '') return null;

      let value = input.trim();
      const prefix = SOCIAL_PREFIXES[platform];
      if (!prefix) return null;

      // Check if it's already a correct full URL (only enforce https)
      if (value.startsWith(prefix.replace('https', 'http'))) {
          return value.replace('http:', 'https:');
      }
      
      // 1. Remove common prefixes and handles
      value = value.replace(/^(https?:\/\/)?(www\.)?/, '');
      
      if (platform === 'linkedin') {
          value = value.replace(/^linkedin\.com\/(in\/)?/i, '');
      } else if (platform === 'tiktok') {
          value = value.replace(/^tiktok\.com\/@/i, '');
          value = value.replace(/^@/, '');
      } else if (platform === 'instagram' || platform === 'twitter') {
          value = value.replace(/^(instagram|twitter)\.com\//i, '');
          value = value.replace(/^@/, '');
      } else if (platform === 'facebook') {
          value = value.replace(/^facebook\.com\//i, '');
      } else if (platform === 'youtube') {
          value = value.replace(/^youtube\.com\/(user\/|c\/|channel\/)?/i, '');
      }

      // 2. Remove trailing slashes
      value = value.replace(/\/$/, '');
      
      if (value === '') return null;

      // 3. Reconstruct the final, correct URL
      return prefix + value;
    };

    /**
     * FIX 2: Validates if a string is a valid email format.
     */
    const isValidEmail = (email) => {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email.trim());
    };

    /**
     * FIX 2: Validates if a string is a valid phone number (no letters, >= 10 digits).
     */
    const isValidPhone = (phone) => {
      if (!phone) return true; 
      if (/[a-zA-Z]/.test(phone)) return false; 
      const cleaned = phone.replace(/\D/g, ''); 
      return cleaned.length >= 10;
    };
    
    /**
     * Displays a toast message to the user.
     */
    const showToast = (message, isError = false) => {
      toastMessage.textContent = message;
      toastMessage.style.backgroundColor = isError ? '#ef4444' : '#FFD700';
      toastMessage.style.color = isError ? 'white' : 'black';
      toastMessage.style.display = 'block';
      setTimeout(() => {
        toastMessage.style.display = 'none';
      }, 3000);
    };

    /**
     * Populates form fields from a client data object fetched from the backend.
     */
    const populateForm = (data) => {
      const setValue = (id, value) => {
        const el = document.getElementById(id);
        if (el && value) el.value = value;
      };

      // Personal Details
      setValue('fullName', data.fullName);
      setValue('title', data.title);
      setValue('phone1', data.phone1);
      setValue('phone2', data.phone2);
      setValue('phone3', data.phone3);
      setValue('email1', data.email1);
      setValue('email2', data.email2);
      setValue('email3', data.email3);

      // Business Details
      setValue('companyName', data.company); 
      setValue('businessWebsite', data.businessWebsite);
      setValue('portfolioWebsite', data.portfolioWebsite);
      setValue('locationMapUrl', data.locationMap); 

      // Photo URL
      if (data.photoUrl) {
        photoUrlInput.value = data.photoUrl;
        photoPreview.src = data.photoUrl;
        photoPreviewContainer.style.display = 'block';
        photoUploadLabel.textContent = 'Photo Uploaded';
        photoUploadLabel.style.backgroundColor = '#22c55e';
      }

      // Working Hours
      if (data.workingHours) {
        ['monFriStart', 'monFriEnd', 'satStart', 'satEnd', 'sunStart', 'sunEnd'].forEach(day => {
          setValue(day, data.workingHours[day]);
        });
      }

      // Social Links
      if (data.socialLinks) {
        ['facebook', 'instagram', 'twitter', 'linkedin', 'tiktok', 'youtube'].forEach(platform => {
          setValue(platform, data.socialLinks[platform]);
        });
      }

      // Bio & Address
      setValue('bio', data.bio);
      setValue('address', data.address);
    };

    // ------------------------
    // Core Application Logic
    // ------------------------

    const fetchClientData = async (id) => {
      try {
        const response = await fetch(`${API_URL}/clients/${id}`);
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `Failed to fetch client data for ID: ${id}`);
        }
        const json = await response.json();
        const data = json.data || json; 
        populateForm(data);
        console.log(`Form populated with client data for ID: ${id}`);
      } catch (error) {
        console.error('Error fetching client data:', error);
        showToast(`Error fetching data: ${error.message}`, true);
      }
    };

    const uploadPhoto = async (file) => {
      if (!file) return;

      const formData = new FormData();
      formData.append('photo', file); 

      try {
        photoUploadLabel.innerHTML = 'Uploading... <span class="spinner"></span>';
        photoUploadLabel.style.backgroundColor = '#3b82f6';

        const response = await fetch(`${API_URL}/upload-photo`, {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Photo upload failed on the server.');
        }

        const photoUrl = data.photoUrl;
        photoUrlInput.value = photoUrl;
        
        // FIX: The `photoPreview.src` is already set by `FileReader` for instant preview. 
        // We ensure the success state is updated here.
        photoUploadLabel.textContent = 'Photo Uploaded';
        photoUploadLabel.style.backgroundColor = '#22c55e';
        photoPreview.src = photoUrl;
        photoPreviewContainer.style.display = 'block';
        showToast('Photo uploaded successfully!');
        return photoUrl;
      } catch (error) {
        console.error('Photo upload error:', error);
        showToast(`Photo upload failed: ${error.message}`, true);
        photoUploadLabel.textContent = 'Photo Upload Failed';
        photoUploadLabel.style.backgroundColor = '#ef4444';
        return null;
      }
    };

    const handleFormSubmission = async (e) => {
      e.preventDefault();
      if (isSaving) return;
      isSaving = true;
      saveBtn.innerHTML = 'Saving... <span class="spinner"></span>';
      saveBtn.disabled = true;

      const formData = new FormData(form);
      const payload = {};
      const socialLinks = {}; // Will hold normalized links
      const workingHours = {};
      const workingHoursKeys = ['monFriStart', 'monFriEnd', 'satStart', 'satEnd', 'sunStart', 'sunEnd'];
      const socialLinksKeys = ['facebook', 'instagram', 'twitter', 'linkedin', 'tiktok', 'youtube'];
      
      for (const [key, value] of formData.entries()) {
        // Exclude the file input from the JSON payload
        if (value && key !== 'photoFile') { 
          payload[key] = value.trim();
        }
      }
      
      try {
        // --- FIX 2: Validation of Phone and Email ---
        const phoneFields = ['phone1', 'phone2', 'phone3'];
        const emailFields = ['email1', 'email2', 'email3'];

        for (const key of phoneFields) {
            if (payload[key] && !isValidPhone(payload[key])) {
              throw new Error(`Invalid phone number for ${key}: Must be 10 digits or more and contain no letters.`);
            }
        }

        for (const key of emailFields) {
            if (payload[key] && !isValidEmail(payload[key])) {
              throw new Error(`Invalid email address for ${key}.`);
            }
        }

        // 1. Data Normalization for Backend Schema
        
        // Map companyName field to the expected 'company' schema field
        if (payload.companyName) {
          payload.company = payload.companyName;
          delete payload.companyName;
        }
        
        // Map locationMapUrl field to the expected 'locationMap' schema field
        if (payload.locationMapUrl) {
          payload.locationMap = payload.locationMapUrl;
          delete payload.locationMapUrl;
        }
        
        // Map photoUrl field
        if (payload.photoUrl) {
            payload.photoUrl = payload.photoUrl;
        }

        // Populate nested workingHours
        for (const key of workingHoursKeys) {
          if (payload[key] && payload[key] !== '--:--') {
            workingHours[key] = payload[key];
            delete payload[key];
          }
        }
        
        // FIX 1 & 4: Populate nested socialLinks with normalization
        for (const key of socialLinksKeys) {
          const normalizedUrl = normalizeSocialLink(key, payload[key]);
          if (normalizedUrl) {
            socialLinks[key] = normalizedUrl;
          }
          // Always delete the flat key from the main payload
          delete payload[key]; 
        }

        if (Object.keys(workingHours).length > 0) payload.workingHours = workingHours;
        if (Object.keys(socialLinks).length > 0) payload.socialLinks = socialLinks;

        // 2. API Call (PUT/POST)
        const url = clientId ? `${API_URL}/clients/${clientId}` : `${API_URL}/clients`;
        const method = clientId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to save client info.');
        }
        
        showToast('Client info saved successfully!');
        
        // If creating a new client (POST), redirect to the edit view (PUT)
        if (!clientId && (data._id || data.recordId)) {
          window.location.href = `admin-form.html?id=${data._id || data.recordId}`;
        }
        
      } catch (error) {
        console.error('Save error:', error);
        showToast(`Save failed: ${error.message}`, true);
      } finally {
        isSaving = false;
        saveBtn.innerHTML = 'Save Info';
        saveBtn.disabled = false;
      }
    };

    const handleViewPdfClick = async () => {
      if (!clientId) return showToast('Please save client info first.', true);
      
      viewPdfBtn.classList.add('pressed');
      viewPdfBtn.innerHTML = 'Generating... <span class="spinner"></span>';
      viewPdfBtn.disabled = true;

      try {
        // NOTE: The backend route is POST /clients/:id/pdf, but the frontend was using a GET-like fetch. 
        // We'll stick to the POST method defined in the adminForm.js
        const response = await fetch(`${API_URL}/clients/${clientId}/pdf`, { method: 'POST' });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to retrieve PDF.');
        }
        
        const data = response.url ? { pdfUrl: response.url } : await response.json();
        const pdfUrl = data.pdfUrl || data.url || response.url;

        if (pdfUrl) {
          window.open(pdfUrl, '_blank');
          showToast('PDF opened successfully!');
        } else {
            throw new Error('PDF URL not returned by server.');
        }
        
      } catch (error) {
        console.error('PDF retrieval error:', error);
        showToast(`PDF retrieval failed: ${error.message}`, true);
      } finally {
        viewPdfBtn.innerHTML = 'View Client Info PDF';
        viewPdfBtn.classList.remove('pressed');
        viewPdfBtn.disabled = false;
      }
    };

    const handleCreateVcardClick = async () => {
      if (!clientId) return showToast('Please save client info first.', true);

      createVcardBtn.classList.add('pressed');
      createVcardBtn.innerHTML = 'Creating... <span class="spinner"></span>';
      createVcardBtn.disabled = true;

      try {
        const response = await fetch(`${API_URL}/clients/${clientId}/vcard`, {
          method: 'POST',
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to create vCard.');
        }

        const data = await response.json();
        showToast('vCard and QR code created successfully! Email sent.', false);

        if (data.vcardUrl) window.open(data.vcardUrl, '_blank');
        
        if (data.qrCodeUrl) {
          const qrCodeWindow = window.open('', '_blank');
          qrCodeWindow.document.write(`
            <html><head><title>QR Code</title>
            <style>body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f0f0f0;}</style>
            </head><body>
              <img src="${data.qrCodeUrl}" alt="QR Code" style="max-width:90%;max-height:90vh;">
            </body></html>
          `);
          qrCodeWindow.document.close();
        }

      } catch (error) {
        console.error('vCard creation error:', error);
        showToast(`vCard creation failed: ${error.message}`, true);
      } finally {
        createVcardBtn.innerHTML = 'Create vCard';
        createVcardBtn.classList.remove('pressed');
        createVcardBtn.disabled = false;
      }
    };

    // ------------------------
    // Initialization & Event Listeners
    // ------------------------

    document.addEventListener('DOMContentLoaded', () => {
      if (clientId) {
        fetchClientData(clientId);
      }
    });

    photoUploadInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        // Instant preview
        const reader = new FileReader();
        reader.onload = (event) => {
          photoPreview.src = event.target.result;
          photoPreviewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);

        // Start upload
        uploadPhoto(file);
      }
    });

    form.addEventListener('submit', handleFormSubmission);
    viewPdfBtn.addEventListener('click', handleViewPdfClick);
    createVcardBtn.addEventListener('click', handleCreateVcardClick);

  })();
</script>
</body>
</html>