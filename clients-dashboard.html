<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartCardLink vCard Client Dashboard | Production</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”—</text></svg>">
  
  <style>
    /* --- CSS Configuration & Core Styles --- */
    :root {
      --primary-color: #FFD700; /* Gold */
      --text-color: #e2e8f0;
      --bg-color: #111;
      --card-bg: #1a1a1a;
      --border-color: #333;
    }
    body {
      font-family: 'Inter', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 2rem 1rem;
      background: none;
      color: var(--text-color);
    }
    /* Background Video (from provided snippet) */
    #bg-video {
      position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: -100;
      filter: brightness(0.4) saturate(1.2); object-fit: cover;
    }
    .dashboard-card {
      background-color: var(--bg-color); border-radius: 1rem; padding: 2rem; width: 100%;
      max-width: 1200px; border: 1px solid var(--border-color); box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
      overflow: hidden; animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    h1.title { color: var(--primary-color); font-size: 1.75rem; font-weight: 700; text-align: center; margin-bottom: 2rem; }
    .controls-container { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1rem; }
    .search-container { display: flex; gap: 0.5rem; flex-grow: 1; max-width: 400px; }
    
    input, select, textarea { 
      flex-grow: 1; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #555; background-color: #222; 
      color: white; transition: all 0.3s ease; box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 8px rgba(255, 215, 0, 0.4); }
    
    .button-group { display: flex; gap: 0.5rem; }
    button { 
      padding: 0.75rem 1.2rem; border-radius: 0.375rem; border: 1px solid var(--primary-color); 
      background-color: var(--card-bg); color: var(--primary-color); font-weight: 700; 
      cursor: pointer; transition: all 0.3s; white-space: nowrap; 
    }
    button:hover { background-color: var(--primary-color); color: var(--bg-color); }
    
    /* Table Styles */
    .table-container { overflow-x: auto; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background-color: #222; color: var(--primary-color); font-weight: 600; white-space: nowrap; }
    td { background-color: var(--card-bg); color: var(--text-color); font-size: 0.9rem; }
    tbody tr:hover { background-color: #2d2d2d; }
    tbody tr.row-success { 
      background-color: #38a1694d !important; /* Green highlight for update */
      transition: background-color 0.5s ease-out; 
    }

    /* Status Badges */
    .status-badge { 
      padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; color: white; white-space: nowrap; 
    }
    .status-Pending { background-color: #d69e2e; } 
    .status-Processed { background-color: #4299e1; } 
    .status-Active { background-color: #38a169; } 
    .status-Disabled { background-color: #e53e3e; } 
    .status-Deleted { background-color: #4a5568; } 
    .client-photo { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #555; }
    .actions-cell button { padding: 0.5rem 0.75rem; font-size: 0.8rem; margin-right: 0.25rem; }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
    .modal-content { 
        background-color: var(--card-bg); margin: 10% auto; padding: 20px; border: 1px solid #555; 
        width: 90%; max-width: 450px; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
        display: flex; flex-direction: column; gap: 15px;
    }
    .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; align-self: flex-end; }
    .modal-content h2 { color: var(--primary-color); margin-top: 0; font-size: 1.4rem; }
    .modal-content textarea { min-height: 120px; resize: vertical; }

    /* Toast Notifications */
    .toast-container { position: fixed; top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 1000; }
    .toast {
      padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-size: 0.9rem; font-weight: 600; 
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); transition: all 0.3s ease-in-out; 
      transform: translateX(100%); opacity: 0; display: flex; justify-content: space-between; align-items: center;
      min-width: 250px;
    }
    .toast.show { transform: translateX(0); opacity: 1; }
    .toast.success { background-color: #10b981; color: white; } 
    .toast.error { background-color: #f43f5e; color: white; } 
    .toast-close-btn { background: none; border: none; color: white; margin-left: 10px; cursor: pointer; font-size: 1.2rem; line-height: 1; }
    .toast-close-btn:hover { color: var(--primary-color); }
    
    /* Loading States */
    #loadingMessage { text-align: center; padding: 2rem; color: var(--primary-color); display: none; }
    #noResults { text-align: center; padding: 2rem; color: #aaa; display: none; }
    .loading-spinner { 
      border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; 
      width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 0.5rem; 
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .dashboard-card { padding: 1rem; }
      .controls-container { flex-direction: column; align-items: stretch; }
      .search-container { max-width: 100%; }
      .button-group { width: 100%; justify-content: space-between; }
      .button-group button { flex-grow: 1; padding: 0.75rem 0.5rem; }
      .table-container { margin: 0 -1rem; width: calc(100% + 2rem); }
      th, td { padding: 0.75rem; }
    }
  </style>
</head>
<body>
  <video autoplay muted loop playsinline id="bg-video">
    <source src="https://res.cloudinary.com/dicvwaud3/video/upload/v1754439276/oyvgam7oizwizgwxaxge.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>

  <div class="dashboard-card">
    <h1 class="title">SmartCardLink vCard Client Dashboard</h1>

    <div class="controls-container">
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search by name, phone, email, or company" aria-label="Search clients" />
        <button id="searchBtn"><i class="fas fa-search"></i> Search</button>
      </div>
      <div class="button-group">
        <select id="statusFilter" aria-label="Filter by status">
          <option value="">All Statuses</option>
          <option value="Active">Active</option>
          <option value="Disabled">Disabled</option>
          <option value="Pending">Pending</option>
          <option value="Processed">Processed</option>
          <option value="Deleted">Deleted</option>
        </select>
        <button id="exportBtn" aria-label="Export to CSV">
             <i class="fas fa-file-export"></i> Export CSV
        </button>
        <button id="resetBtn" aria-label="Reset Filters">
             <i class="fas fa-undo"></i> Reset
        </button>
      </div>
    </div>
    
    <div id="totals" style="text-align: center; color: var(--primary-color); padding: 0.5rem; margin-bottom: 1rem; display: none;"></div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Photo</th>
            <th>Full Name</th>
            <th>Company</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Date Created</th>
            <th>Active Months</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="clientTableBody" role="alert" aria-live="polite">
          </tbody>
      </table>
    </div>
    
    <div id="loadingMessage">
        <div class="loading-spinner"></div>
        <p>Loading all client data from MongoDB...</p>
    </div>
    <div id="noResults">No clients found matching your criteria.</div>
  </div>
  
  <div id="notesModal" class="modal">
      <div class="modal-content">
          <span class="close-btn" id="modalCloseBtn">&times;</span>
          <h2 id="modalTitle">Reason for Action</h2>
          <textarea id="modalTextarea" placeholder="Please provide a mandatory reason for this action (e.g., 'Client requested a 6-month pause')." required></textarea>
          <button id="modalConfirmBtn">Confirm Action</button>
      </div>
  </div>
  
  <div class="toast-container" id="toast-container"></div>

  <script>
    // --- Configuration Block (API URL) ---
    
    // CRITICAL: The base URL of the Render backend API, used for all data fetching and status updates.
    const API_BASE_URL = "https://smartcardlink-api.onrender.com"; 
    
    // --- Global State & DOM Elements ---
    let allClientData = []; // Stores the full, un-filtered client data from the last successful fetch.

    // DOM References
    const clientTableBody = document.getElementById('clientTableBody');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const exportBtn = document.getElementById('exportBtn');
    const resetBtn = document.getElementById('resetBtn');
    const noResultsDiv = document.getElementById('noResults');
    const totalsDiv = document.getElementById('totals');
    const loadingMessage = document.getElementById('loadingMessage');
    const notesModal = document.getElementById('notesModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalTextarea = document.getElementById('modalTextarea');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn'); 
    const toastContainer = document.getElementById('toast-container');

    // --- Utility Functions ---

    /**
     * Non-blocking Toast notification for user feedback.
     */
    function showToast(message, type = 'success') {
        if (!toastContainer) return;
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        toast.innerHTML = `
            <span role="status" aria-live="polite">${message}</span>
            <button class="toast-close-btn">&times;</button>
        `;
        
        const closeBtn = toast.querySelector('.toast-close-btn');
        const closeToast = () => {
            toast.classList.remove('show');
            // Remove element only after CSS transition finishes
            toast.addEventListener('transitionend', () => toast.remove());
        };
        closeBtn.addEventListener('click', closeToast);

        toastContainer.prepend(toast); 
        setTimeout(() => { toast.classList.add('show'); }, 10);
        
        // Auto-dismiss after 6 seconds
        setTimeout(closeToast, 6000);
    }

    /**
     * Hides the audit notes modal and clears its state.
     */
    function hideModal() {
        if (notesModal) {
            notesModal.style.display = 'none';
            modalTextarea.value = ''; 
            // CRITICAL: Remove the previous event handler to prevent stacking
            modalConfirmBtn.onclick = null; 
        }
    }

    /**
     * Creates HTML for a color-coded status badge.
     */
    function getStatusBadge(status) {
      const statusClean = status 
        ? status.charAt(0).toUpperCase() + status.slice(1).toLowerCase() 
        : 'Pending';
      const statusClass = statusClean.replace(/\s/g, ''); 
      return `<span class="status-badge status-${statusClass}">${statusClean}</span>`;
    }

    /**
     * Calculates the approximate number of active months since the vCard was created.
     */
    function calculateActiveMonths(createdDateStr) {
        if (!createdDateStr) return 'N/A';
        const createdDate = new Date(createdDateStr);
        const now = new Date();

        let totalMonths = (now.getFullYear() - createdDate.getFullYear()) * 12;
        totalMonths += now.getMonth() - createdDate.getMonth();
        
        if (now.getDate() < createdDate.getDate()) {
            totalMonths--;
        }
        
        return totalMonths > 0 ? `${totalMonths} months` : '0 months';
    }
    
    /**
     * Debounces a function call to prevent excessive execution (e.g., on input).
     */
    const debounce = (func, delay) => {
        let timeoutId;
        return (...args) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => { func.apply(this, args); }, delay);
        };
    };

    // --- Core UI & Rendering Functions ---

    /**
     * Renders the table based on the provided (filtered) data array.
     */
    function renderTable(data) {
      if (!clientTableBody) return;
      
      clientTableBody.innerHTML = '';

      if (data.length === 0) {
        noResultsDiv.style.display = 'block';
        totalsDiv.style.display = 'none';
        return;
      }

      noResultsDiv.style.display = 'none';
      
      data.forEach(client => {
        const tr = document.createElement('tr');
        // Unique identifier for in-place updates
        tr.dataset.clientId = client._id; 
        
        const currentStatus = client.status || 'Pending';
        const createdDate = client.vcardCreatedDate ? client.vcardCreatedDate.split('T')[0] : 'N/A';
        const activeMonths = calculateActiveMonths(client.vcardCreatedDate);
        const photoUrl = client.photoUrl || 'https://placehold.co/50x50/111/fff?text=No+Photo';

        tr.innerHTML = `
          <td><img src="${photoUrl}" alt="Client Photo" class="client-photo" onerror="this.onerror=null; this.src='https://placehold.co/50x50/111/fff?text=No+Photo';" /></td>
          <td>${client.fullName || 'N/A'}</td>
          <td>${client.company || 'N/A'}</td>
          <td>${client.email1 || 'N/A'}</td>
          <td>${client.phone1 || 'N/A'}</td>
          <td>${createdDate}</td>
          <td>${activeMonths}</td>
          <td>${getStatusBadge(currentStatus)}</td>
          <td class="actions-cell">
            ${currentStatus === 'Active' ? 
              `<button class="action-btn btn-disable" onclick="window.showNotesModal('Disable', '${client._id}', 'Disabled')"><i class="fas fa-ban"></i> Disable</button>` :
              `<button class="action-btn btn-enable" onclick="window.showNotesModal('Enable', '${client._id}', 'Active')"><i class="fas fa-check-circle"></i> Enable</button>`
            }
            <button class="action-btn btn-delete" onclick="window.showNotesModal('Delete', '${client._id}', 'Deleted')"><i class="fas fa-trash-alt"></i> Delete</button>
          </td>
        `;
        clientTableBody.appendChild(tr);
      });
      
      updateTotals(data);
    }

    /**
     * Filters the local data set (`allClientData`) and triggers a re-render of the table.
     * This is used for search, filter, and post-status-change updates (in-place method).
     */
    function filterAndSearch() {
        if (!searchInput || !statusFilter) return;
        
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedStatus = statusFilter.value;
        
        const filteredData = allClientData.filter(client => {
            const matchesSearch = 
                (client.fullName && client.fullName.toLowerCase().includes(searchTerm)) ||
                (client.phone1 && client.phone1.toLowerCase().includes(searchTerm)) ||
                (client.email1 && client.email1.toLowerCase().includes(searchTerm)) ||
                (client.company && client.company.toLowerCase().includes(searchTerm));
            
            const matchesStatus = selectedStatus === '' || client.status === selectedStatus;
            
            return matchesSearch && matchesStatus;
        });
        
        renderTable(filteredData);
    }

    /**
     * Updates the summary statistics below the controls.
     */
    function updateTotals(data) {
        if (!totalsDiv) return;
        
        const counts = { Active: 0, Pending: 0, Processed: 0, Disabled: 0, Deleted: 0 };
        data.forEach(client => {
            const status = client.status || 'Pending';
            if (counts.hasOwnProperty(status)) {
                counts[status]++;
            }
        });
        
        totalsDiv.style.display = 'block';
        totalsDiv.innerHTML = `
            **Total Clients:** ${data.length} | 
            **Active:** ${counts.Active} | 
            **Pending:** ${counts.Pending} | 
            **Processed:** ${counts.Processed} |
            **Disabled:** ${counts.Disabled} |
            **Deleted:** ${counts.Deleted}
        `;
    }

    // --- API & Data Handling Functions ---

    /**
     * Initial fetch of all client data from the Render backend.
     */
    async function fetchAllClients() {
      if (!API_BASE_URL || API_BASE_URL.includes("YOUR_RENDER_BACKEND_API_URL_HERE")) {
          return showToast('Configuration Error: Please set your actual Render API URL in the HTML config.', 'error');
      }
      
      loadingMessage.style.display = 'block';
      noResultsDiv.style.display = 'none';
      clientTableBody.innerHTML = '';
      
      try {
        // NOTE: Authentication removed as per requirements (single-user dashboard)
        const response = await fetch(`${API_BASE_URL}/clients/all`);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ message: `Server error, status: ${response.status}` }));
          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        // Ensure data array exists
        allClientData = Array.isArray(result.data) ? result.data : [];
        
        filterAndSearch(); // Initial render uses filter logic on all data
        showToast(`Successfully loaded ${allClientData.length} clients.`, 'success');
      } catch (error) {
        console.error("Error fetching all clients:", error);
        showToast(`Failed to fetch clients: ${error.message}`, 'error');
        noResultsDiv.style.display = 'block';
      } finally {
        loadingMessage.style.display = 'none';
      }
    }

    /**
     * Executes the API call to change a client's status, including mandatory notes.
     * Updates the UI in-place by modifying the local state and re-rendering the filtered view.
     */
    async function changeClientStatus(clientId, newStatus, notes) {
        const row = clientTableBody.querySelector(`tr[data-client-id="${clientId}"]`);
        const originalHtml = row ? row.innerHTML : null;
        
        // Show row-level loading indicator
        if (row) {
             row.innerHTML = `<td colspan="9" style="text-align: center; color: var(--primary-color); padding: 0.5rem;">
                <div class="loading-spinner" style="width: 20px; height: 20px; border-width: 3px; margin: 0 auto;"></div>
                <small>Updating status...</small>
            </td>`;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/clients/${clientId}/status/${newStatus}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    // No Authorization header needed as per requirement 11
                },
                body: JSON.stringify({ notes }) 
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `Server error, status: ${response.status}` }));
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            
            // --- Performance Optimization: In-Place UI/State Update ---
            const clientIndex = allClientData.findIndex(c => c._id === clientId);
            if (clientIndex > -1) {
                // 1. Update the local data copy
                allClientData[clientIndex].status = newStatus;
                
                // 2. Re-filter/Re-render the current view (fast, as it uses local data)
                filterAndSearch(); 

                // 3. Highlight the specific row (needs to be queried again after re-render)
                const updatedRow = clientTableBody.querySelector(`tr[data-client-id="${clientId}"]`);
                if (updatedRow) {
                    updatedRow.classList.add('row-success');
                    setTimeout(() => { updatedRow.classList.remove('row-success'); }, 2000); 
                }
            }
            
            showToast(`Status updated to ${newStatus}. Note: ${notes.substring(0, 30)}...`, 'success');

        } catch (error) {
            console.error("Error changing client status:", error);
            showToast(`Failed to change status: ${error.message}`, 'error');
            // Restore row content on error
            if (row && originalHtml) {
                row.innerHTML = originalHtml;
            }
        }
    }

    /**
     * Shows the mandatory notes modal and sets the unique confirmation handler.
     */
    function showNotesModal(action, clientId, newStatus) {
        if (!notesModal) return;

        modalTitle.innerText = `${action} Client Status`;
        modalTextarea.placeholder = `Mandatory reason for changing status to '${newStatus}'.`;
        modalTextarea.value = '';
        notesModal.style.display = 'block';

        setTimeout(() => { modalTextarea.focus(); }, 10); 

        // Set the unique handler for this action
        modalConfirmBtn.onclick = () => {
            const notes = modalTextarea.value.trim();
            if (!notes) {
                showToast('Audit reason is required to proceed.', 'error');
                return;
            }

            hideModal(); 
            changeClientStatus(clientId, newStatus, notes);
        };
    }

    /**
     * Exports the *entire* loaded data set (`allClientData`) to a CSV file.
     */
    function exportToCsv() {
        if (allClientData.length === 0) {
            return showToast("No client data loaded to export.", 'error');
        }
        
        const headers = ["ID", "Full Name", "Company", "Email", "Phone", "Status", "Date Created", "Active Months"];
        
        const data = allClientData.map(client => [
            client._id || '',
            client.fullName || '',
            client.company || '',
            client.email1 || '',
            client.phone1 || '',
            client.status || 'Pending',
            client.vcardCreatedDate ? client.vcardCreatedDate.split('T')[0] : '',
            calculateActiveMonths(client.vcardCreatedDate)
        ]);

        let csvContent = headers.join(",") + "\n";
        data.forEach(row => {
            // Proper CSV escaping: surround field with quotes, double inner quotes
            const rowString = row.map(field => `"${field.toString().replace(/"/g, '""')}"`).join(",");
            csvContent += rowString + "\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `client_data_${new Date().toISOString().slice(0, 10)}.csv`);
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast(`Successfully exported ${allClientData.length} clients to CSV.`, 'success');
    }

    // --- Initialization and Event Listeners ---
    function init() {
      // Data Fetch on Load
      fetchAllClients();

      // Attach Search & Filter Handlers (using debounced function for input)
      if (searchInput) searchInput.addEventListener('input', debouncedFilterAndSearch);
      if (statusFilter) statusFilter.addEventListener('change', filterAndSearch);
      if (document.getElementById('searchBtn')) document.getElementById('searchBtn').addEventListener('click', filterAndSearch);
      
      // Attach Action Handlers
      if (exportBtn) exportBtn.addEventListener('click', exportToCsv);
      
      // Reset Handler
      if (resetBtn) resetBtn.addEventListener('click', () => { 
        searchInput.value = ''; 
        statusFilter.value = ''; 
        filterAndSearch(); // Triggers a re-render of all original data
      });

      // Modal Close Handlers (using direct element references)
      if (modalCloseBtn) modalCloseBtn.addEventListener('click', hideModal);
      if (notesModal) {
          window.addEventListener('click', (event) => {
              if (event.target === notesModal) hideModal();
          });
      }
    }

    document.addEventListener('DOMContentLoaded', init);

    // Expose required functions to the global scope for HTML inline calls (Action buttons)
    window.showNotesModal = showNotesModal;
  </script>
</body>
</html>